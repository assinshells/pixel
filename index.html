<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grid 1M pixels - Advertising Space</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding: 20px;
      }
      .main-container {
        max-width: 1200px;
        margin: 0 auto;
      }
      canvas {
        border: 2px solid #333;
        image-rendering: pixelated;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        background-color: white;
        cursor: crosshair;
        display: block;
        margin: 0 auto;
      }
      .info-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .file-upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      .file-upload-area:hover {
        border-color: #28a745;
        background-color: #f8f9fa;
      }
      .file-upload-area.dragover {
        border-color: #28a745;
        background-color: #e8f5e9;
      }
      .preview-image {
        max-width: 100%;
        max-height: 200px;
        margin-top: 15px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="sticky-top bg-white">
      <div class="container">
        <header class="border-bottom lh-1 py-3">
          <div
            class="row flex-nowrap justify-content-between align-items-center"
          >
            <div class="col-4 pt-1">
              <a class="link-secondary" href="#">Subscribe</a>
            </div>
            <div class="col-4 text-center">
              <a
                class="blog-header-logo text-body-emphasis text-decoration-none"
                href="#"
                >Large</a
              >
            </div>
            <div class="col-4 d-flex justify-content-end align-items-center">
              <button class="btn btn-success" id="purchaseBtn" disabled>
                Purchase â€”
                <span id="selectedBlocks">0</span> blocks |
                <span id="totalAmount">$0</span>
              </button>
            </div>
          </div>
        </header>
        <div class="nav-scroller py-1 mb-3 border-bottom">
          <nav class="nav nav-underline justify-content-between">
            <a class="nav-item nav-link link-body-emphasis active" href="#"
              >World</a
            >
            <a class="nav-item nav-link link-body-emphasis" href="#">U.S.</a>
            <a class="nav-item nav-link link-body-emphasis" href="#"
              >Technology</a
            >
            <a class="nav-item nav-link link-body-emphasis" href="#">Design</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Culture</a>
            <a class="nav-item nav-link link-body-emphasis" href="#"
              >Business</a
            >
            <a class="nav-item nav-link link-body-emphasis" href="#"
              >Politics</a
            >
            <a class="nav-item nav-link link-body-emphasis" href="#">Opinion</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Science</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Health</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Style</a>
            <a class="nav-item nav-link link-body-emphasis" href="#">Travel</a>
          </nav>
        </div>
      </div>
    </div>
    <div class="main-container">
      <div class="info-panel">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h3 class="mb-2">Advertising Grid - $100 per block</h3>
            <p class="mb-0 text-muted">
              Click blocks to select, then purchase your advertising space
            </p>
          </div>

          <div class="col-md-6 text-md-end"></div>
        </div>
      </div>

      <canvas id="grid" width="1000" height="1000"></canvas>
    </div>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Complete Your Purchase</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Your Email *</label>
              <input
                type="email"
                class="form-control"
                id="buyerEmail"
                placeholder="your@email.com"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Your Name *</label>
              <input
                type="text"
                class="form-control"
                id="buyerName"
                placeholder="John Doe"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Target Website URL *</label>
              <input
                type="url"
                class="form-control"
                id="websiteUrl"
                placeholder="https://yourwebsite.com"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Alt Text / Description *</label>
              <input
                type="text"
                class="form-control"
                id="altText"
                placeholder="Your advertisement description"
                required
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Upload Banner Image *</label>
              <div class="file-upload-area" id="uploadArea">
                <input
                  type="file"
                  id="bannerFile"
                  accept="image/*"
                  style="display: none"
                />
                <div id="uploadText">
                  <i
                    class="bi bi-cloud-upload"
                    style="font-size: 48px; color: #ccc"
                  ></i>
                  <p class="mt-2 mb-0">Click to upload or drag and drop</p>
                  <small class="text-muted">PNG, JPG, GIF (max 5MB)</small>
                </div>
                <div id="previewContainer" style="display: none">
                  <img id="previewImage" class="preview-image" alt="Preview" />
                  <p class="mt-2 mb-0" id="fileName"></p>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger mt-2"
                    id="removeFile"
                  >
                    Remove
                  </button>
                </div>
              </div>
            </div>

            <div class="alert alert-info">
              <strong>Purchase Summary:</strong><br />
              Blocks: <span id="modalBlocks">0</span><br />
              Block Coordinates: <span id="modalCoordinates">-</span><br />
              Total: <span id="modalAmount">$0</span><br />
              <small class="text-muted"
                >Your purchase request will be sent to the seller for
                approval</small
              >
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-success" id="confirmPurchase">
              Submit Purchase Request
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="ads-config.js"></script>
    <script>
      const canvas = document.getElementById("grid");
      const ctx = canvas.getContext("2d");

      const BLOCK_SIZE = 10;
      const GRID_SIZE = 1000;
      const BLOCKS = GRID_SIZE / BLOCK_SIZE;
      const BLOCK_PRICE = 100;

      // State management
      const blocks = new Uint8Array(BLOCKS * BLOCKS); // 0: available, 1: selected, 2: purchased
      const purchasedAds = [];
      let selectedCount = 0;
      let selectedBlocks = new Set();
      let uploadedBannerFile = null;
      let uploadedBannerDataUrl = null;

      // Load ads from config file
      loadAdsFromConfig();

      function loadAdsFromConfig() {
        if (typeof ADS_CONFIG === "undefined") {
          console.error("ads-config.js not loaded!");
          return;
        }

        ADS_CONFIG.forEach((adConfig) => {
          purchasedAds.push({
            blocks: adConfig.blocks,
            bannerUrl: adConfig.bannerUrl,
            websiteUrl: adConfig.websiteUrl,
            altText: adConfig.altText,
          });
        });

        // Mark blocks as purchased
        purchasedAds.forEach((ad) => {
          ad.blocks.forEach((block) => {
            const index = block.y * BLOCKS + block.x;
            blocks[index] = 2;
          });
        });

        // Load images
        purchasedAds.forEach((ad) => {
          const img = new Image();
          img.onload = () => {
            ad.image = img;
            drawGrid();
          };
          img.src = ad.bannerUrl;
        });
      }

      // File upload handling
      const uploadArea = document.getElementById("uploadArea");
      const bannerFile = document.getElementById("bannerFile");
      const uploadText = document.getElementById("uploadText");
      const previewContainer = document.getElementById("previewContainer");
      const previewImage = document.getElementById("previewImage");
      const fileName = document.getElementById("fileName");
      const removeFile = document.getElementById("removeFile");

      uploadArea.addEventListener("click", () => {
        if (!uploadedBannerFile) {
          bannerFile.click();
        }
      });

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          handleFileSelect(file);
        }
      });

      bannerFile.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          handleFileSelect(file);
        }
      });

      removeFile.addEventListener("click", (e) => {
        e.stopPropagation();
        uploadedBannerFile = null;
        uploadedBannerDataUrl = null;
        bannerFile.value = "";
        uploadText.style.display = "block";
        previewContainer.style.display = "none";
      });

      function handleFileSelect(file) {
        if (file.size > 5 * 1024 * 1024) {
          alert("File size must be less than 5MB");
          return;
        }

        uploadedBannerFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedBannerDataUrl = e.target.result;
          previewImage.src = uploadedBannerDataUrl;
          fileName.textContent = file.name;
          uploadText.style.display = "none";
          previewContainer.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      function drawGrid() {
        ctx.clearRect(0, 0, GRID_SIZE, GRID_SIZE);

        // Draw all blocks
        for (let y = 0; y < BLOCKS; y++) {
          for (let x = 0; x < BLOCKS; x++) {
            const index = y * BLOCKS + x;
            const state = blocks[index];

            if (state === 2) {
              // Purchased
              ctx.fillStyle = "#fff";
            } else if (state === 1) {
              // Selected
              ctx.fillStyle = "#81c784";
            } else {
              // Available
              ctx.fillStyle = "#eee";
            }

            ctx.fillRect(
              x * BLOCK_SIZE,
              y * BLOCK_SIZE,
              BLOCK_SIZE,
              BLOCK_SIZE
            );

            // Draw borders
            ctx.strokeStyle = "#ccc";
            ctx.lineWidth = 0.5;
            ctx.strokeRect(
              x * BLOCK_SIZE,
              y * BLOCK_SIZE,
              BLOCK_SIZE,
              BLOCK_SIZE
            );
          }
        }

        // Draw purchased banners
        purchasedAds.forEach((ad) => {
          if (ad.image && ad.image.complete) {
            const minX = Math.min(...ad.blocks.map((b) => b.x));
            const minY = Math.min(...ad.blocks.map((b) => b.y));
            const maxX = Math.max(...ad.blocks.map((b) => b.x));
            const maxY = Math.max(...ad.blocks.map((b) => b.y));

            const width = (maxX - minX + 1) * BLOCK_SIZE;
            const height = (maxY - minY + 1) * BLOCK_SIZE;

            ctx.drawImage(
              ad.image,
              minX * BLOCK_SIZE,
              minY * BLOCK_SIZE,
              width,
              height
            );
          }
        });
      }

      function updateUI() {
        const totalAmount = selectedCount * BLOCK_PRICE;
        document.getElementById(
          "totalAmount"
        ).textContent = `Selected: $${totalAmount.toLocaleString()}`;
        document.getElementById("selectedBlocks").textContent = selectedCount;
        document.getElementById("purchaseBtn").disabled = selectedCount === 0;
      }

      function getBlockCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / BLOCK_SIZE);
        const y = Math.floor((e.clientY - rect.top) / BLOCK_SIZE);
        return { x, y };
      }

      function getAdAtPosition(x, y) {
        return purchasedAds.find((ad) =>
          ad.blocks.some((block) => block.x === x && block.y === y)
        );
      }

      canvas.addEventListener("mousemove", (e) => {
        const { x, y } = getBlockCoords(e);

        if (x >= 0 && x < BLOCKS && y >= 0 && y < BLOCKS) {
          const ad = getAdAtPosition(x, y);
          const row = y + 1;
          const col = x + 1;
          const totalAmount = selectedCount * BLOCK_PRICE;

          if (ad) {
            canvas.title = `${ad.altText} - Click to visit`;
            canvas.style.cursor = "pointer";
          } else {
            canvas.title = `Block ${row}.${col} | Selected: $${totalAmount.toLocaleString()}`;
            canvas.style.cursor =
              blocks[y * BLOCKS + x] === 2 ? "not-allowed" : "crosshair";
          }
        }
      });

      canvas.addEventListener("click", (e) => {
        const { x, y } = getBlockCoords(e);
        const index = y * BLOCKS + x;

        // Check if clicking on ad
        const ad = getAdAtPosition(x, y);
        if (ad) {
          window.open(ad.websiteUrl, "_blank");
          return;
        }

        // Can't select purchased blocks
        if (blocks[index] === 2) {
          return;
        }

        // Toggle selection
        if (blocks[index] === 0) {
          blocks[index] = 1;
          selectedCount++;
          selectedBlocks.add(`${x},${y}`);
        } else if (blocks[index] === 1) {
          blocks[index] = 0;
          selectedCount--;
          selectedBlocks.delete(`${x},${y}`);
        }

        drawGrid();
        updateUI();
      });

      // Purchase modal
      const purchaseModal = new bootstrap.Modal(
        document.getElementById("purchaseModal")
      );

      document.getElementById("purchaseBtn").addEventListener("click", () => {
        const blocksList = Array.from(selectedBlocks)
          .map((key) => {
            const [x, y] = key.split(",").map(Number);
            return `${y + 1}.${x + 1}`;
          })
          .join(", ");

        document.getElementById("modalBlocks").textContent = selectedCount;
        document.getElementById("modalCoordinates").textContent = blocksList;
        document.getElementById("modalAmount").textContent = `$${(
          selectedCount * BLOCK_PRICE
        ).toLocaleString()}`;
        purchaseModal.show();
      });

      document
        .getElementById("confirmPurchase")
        .addEventListener("click", async () => {
          const buyerEmail = document.getElementById("buyerEmail").value.trim();
          const buyerName = document.getElementById("buyerName").value.trim();
          const websiteUrl = document.getElementById("websiteUrl").value.trim();
          const altText = document.getElementById("altText").value.trim();

          if (
            !buyerEmail ||
            !buyerName ||
            !websiteUrl ||
            !altText ||
            !uploadedBannerFile
          ) {
            alert(
              "Please fill in all required fields and upload a banner image"
            );
            return;
          }

          // Prepare purchase data
          const newBlocks = Array.from(selectedBlocks).map((key) => {
            const [x, y] = key.split(",").map(Number);
            return { x, y, coord: `${y + 1}.${x + 1}` };
          });

          const purchaseData = {
            buyerEmail,
            buyerName,
            websiteUrl,
            altText,
            blocks: newBlocks.map((b) => b.coord).join(", "),
            blockCount: selectedCount,
            totalAmount: selectedCount * BLOCK_PRICE,
            timestamp: new Date().toLocaleString(),
            bannerFileName: uploadedBannerFile.name,
            bannerSize: `${uploadedBannerFile.size} bytes`,
          };

          // Create email body
          const emailSubject = `New Purchase Request - ${selectedCount} blocks ($${
            selectedCount * BLOCK_PRICE
          })`;
          const emailBody = `
New Advertising Purchase Request

BUYER INFORMATION:
- Name: ${buyerName}
- Email: ${buyerEmail}

PURCHASE DETAILS:
- Blocks: ${selectedCount}
- Block Coordinates: ${purchaseData.blocks}
- Total Amount: $${(selectedCount * BLOCK_PRICE).toLocaleString()}
- Timestamp: ${purchaseData.timestamp}

ADVERTISEMENT DETAILS:
- Website URL: ${websiteUrl}
- Alt Text: ${altText}
- Banner File: ${uploadedBannerFile.name}
- Banner Size: ${(uploadedBannerFile.size / 1024).toFixed(2)} KB

Note: The buyer has attached the banner image. Please review and upload it manually to approve this purchase.
        `.trim();

          console.log("=== PURCHASE REQUEST ===");
          console.log("Subject:", emailSubject);
          console.log("Body:", emailBody);
          console.log("Attachment:", uploadedBannerFile);
          console.log("Block coordinates for ads-config.js:");
          console.log(
            JSON.stringify(
              newBlocks.map((b) => ({ x: b.x, y: b.y })),
              null,
              2
            )
          );
          console.log("======================");

          // Show mailto link for manual sending (or use backend API)
          const SELLER_EMAIL = "seller@example.com"; // Configure seller email
          const mailtoLink = `mailto:${SELLER_EMAIL}?subject=${encodeURIComponent(
            emailSubject
          )}&body=${encodeURIComponent(emailBody)}`;

          // In production, send via backend API:
          // const formData = new FormData();
          // formData.append('banner', uploadedBannerFile);
          // formData.append('data', JSON.stringify(purchaseData));
          // const response = await fetch('/api/purchase', { method: 'POST', body: formData });

          // Reset selection
          selectedBlocks.forEach((key) => {
            const [x, y] = key.split(",").map(Number);
            const index = y * BLOCKS + x;
            blocks[index] = 0;
          });

          selectedBlocks.clear();
          selectedCount = 0;
          uploadedBannerFile = null;
          uploadedBannerDataUrl = null;

          drawGrid();
          updateUI();
          purchaseModal.hide();

          // Clear form
          document.getElementById("buyerEmail").value = "";
          document.getElementById("buyerName").value = "";
          document.getElementById("websiteUrl").value = "";
          document.getElementById("altText").value = "";
          bannerFile.value = "";
          uploadText.style.display = "block";
          previewContainer.style.display = "none";

          alert(
            `Purchase request submitted successfully!\n\nThe seller will receive:\n- Your contact information\n- Block coordinates: ${
              purchaseData.blocks
            }\n- Total amount: $${(
              selectedCount * BLOCK_PRICE
            ).toLocaleString()}\n- Your banner file\n\nYou will be contacted once the seller approves your purchase.`
          );

          // Optional: Open default email client
          if (
            confirm(
              "Would you like to open your email client to send this request?"
            )
          ) {
            window.location.href = mailtoLink;
          }
        });

      drawGrid();
      updateUI();
    </script>
  </body>
</html>
